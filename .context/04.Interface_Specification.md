# Interface & Integration Specifications

## 1. Centralized Notification Service (Internal API)
All modules (Roster, Finance, Birthdays) must trigger communications through this unified interface.
- **Service Logic:** 
    1. Fetch `notification_configs` from Supabase using `trigger_type`.
    2. If `use_ai` is TRUE: Call Gemini 1.5 Flash with `prompt_template` + `context`.
    3. If `use_ai` is FALSE: Hydrate `static_template` using Handlebars-style replacement.
    4. Route to `transport` (Email via Resend / WhatsApp via QR Provider).

- **Request JSON Contract:**
```json
{
  "recipient_uid": "string",
  "trigger_type": "ROSTER_REMINDER | BIRTHDAY_GREETING | PAYMENT_OVERDUE | SWOP_REQUEST",
  "days_out": "number (optional)",
  "context": {
    "preferred_name": "string",
    "event_name": "string",
    "date": "YYYY/MM/DD",
    "amount_due": "number (optional)",
    "location": "string (optional)"
  }
}

## 2. Google Drive Storage Interface
- **Root Directory:** `etc-pwa/`
- **Finance Path:** `etc-pwa/Finances/YYYY/[MM]_MonthName/`
- **Maintenance Path:** `etc-pwa/Maintenance/YYYY/`
- **File Naming Convention:** `YYYY-MM-DD_MemberUID_Amount_Merchant.jpg`
- **Permissions:** Writing via Service Account; Viewing via Authenticated Proxy (Committee Only).

## 3. Image Processing Specification
- **Library:** `browser-image-compression` (Client-side execution before upload).
- **Constraints:** 
    - Max Width/Height: 1280px.
    - Output Format: JPEG.
    - Quality: 0.8.
    - Max File Size: 500KB.

## 4. Google Sheets Data Contract
- **Members_Master (Source of Truth):**
    - Columns: `UID (ETC-XXXX), FirstName, LastName, PreferredName, Email, Phone, Birthday, IsCommittee`.
- **Roster_2026:**
    - Columns: `Date (YYYY/MM/DD), Day, EventName, MemberUID, DisplayName`.
- **Finance_Log:**
    - Columns: `Date, MemberUID, Amount, Category, Description, GDrive_Link, Status`.

## 5. Google People API (Contact Sync)
- **Matching Logic:** Primary key is `Email`.
- **Labeling:** Apply Google Contact Label "Club Member 2026".
- **Commentary:** Update "Notes" field with string: `Membership Status: [Status] | Last Sync: [Timestamp]`.

## 6. Gemini AI Integration
- **Preferred Model:** `gemini-1.5-flash` (Primary), `gemini-1.5-pro` (Configurable fallback).
- **Input:** System Prompt (from `notification_configs`) + User Context Data.
- **Output:** Clean string (text only) for WhatsApp/Email body.